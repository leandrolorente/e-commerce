<div class="admin-products-container">
  <div class="page-header">
    <h1>Gerenciar Produtos</h1>
    <button class="btn-add-product" (click)="openCreateModal()">
      ‚ûï Adicionar Produto
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Buscar por nome..." 
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
      />
    </div>
    <select [(ngModel)]="selectedCategory" (change)="applyFilters()" class="filter-select">
      <option value="">Todas as Categorias</option>
      @for (cat of categories; track cat.value) {
        <option [value]="cat.value">{{ cat.label }}</option>
      }
    </select>
  </div>

  <!-- Tabela de Produtos -->
  <div class="products-table">
    @if (isLoading()) {
      <div class="loading">Carregando produtos...</div>
    } @else if (filteredProducts().length === 0) {
      <div class="empty-state">
        <p>Nenhum produto encontrado</p>
      </div>
    } @else {
      <table>
        <thead>
          <tr>
            <th>Imagem</th>
            <th>Nome</th>
            <th>Categoria</th>
            <th>Pre√ßo</th>
            <th>Estoque</th>
            <th>Avalia√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          @for (product of filteredProducts(); track product.id) {
            <tr>
              <td>
                <img [src]="product.images[0]" [alt]="product.name" class="product-image">
              </td>
              <td>
                <strong>{{ product.name }}</strong>
                <p class="product-desc">{{ product.description | slice:0:60 }}...</p>
              </td>
              <td>
                <span class="category-badge">{{ getCategoryLabel(product.category) }}</span>
              </td>
              <td>
                <div class="price-info">
                  @if (product.discountPrice) {
                    <span class="discount-price">R$ {{ product.discountPrice.toFixed(2) }}</span>
                    <span class="original-price">R$ {{ product.price.toFixed(2) }}</span>
                  } @else {
                    <span class="price">R$ {{ product.price.toFixed(2) }}</span>
                  }
                </div>
              </td>
              <td>
                <span [class.low-stock]="product.stock < 10">
                  {{ product.stock }} un.
                </span>
              </td>
              <td>
                <div class="rating">
                  ‚≠ê {{ product.rating }} ({{ product.reviewCount }})
                </div>
              </td>
              <td>
                <div class="actions">
                  <button class="btn-icon btn-edit" (click)="openEditModal(product)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn-icon btn-delete" (click)="confirmDelete(product)" title="Excluir">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>

<!-- Modal de Criar/Editar -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode() ? 'Editar Produto' : 'Novo Produto' }}</h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>
      
      <form class="product-form" (ngSubmit)="saveProduct()">
        <div class="form-row">
          <div class="form-group">
            <label>Nome do Produto *</label>
            <input 
              type="text" 
              [(ngModel)]="formData.name" 
              name="name"
              required
              placeholder="Ex: Pomada Cicatrizante"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label>Descri√ß√£o *</label>
            <textarea 
              [(ngModel)]="formData.description"
              name="description"
              rows="3"
              required
              placeholder="Descreva o produto..."
            ></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Categoria *</label>
            <select [(ngModel)]="formData.category" name="category" required>
              <option value="">Selecione...</option>
              @for (cat of categories; track cat.value) {
                <option [value]="cat.value">{{ cat.label }}</option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input 
              type="number" 
              [(ngModel)]="formData.price"
              name="price"
              step="0.01"
              min="0"
              required
              placeholder="0.00"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Pre√ßo com Desconto (R$)</label>
            <input 
              type="number" 
              [(ngModel)]="formData.discountPrice"
              name="discountPrice"
              step="0.01"
              min="0"
              placeholder="0.00"
            />
          </div>

          <div class="form-group">
            <label>Estoque *</label>
            <input 
              type="number" 
              [(ngModel)]="formData.stock"
              name="stock"
              min="0"
              required
              placeholder="0"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label>Imagens do Produto</label>
            
            <!-- √Årea de Upload com Drag & Drop -->
            <div 
              class="image-upload-area"
              [class.dragging]="isDragging()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              (click)="fileInput.click()"
            >
              <div class="upload-icon">üìÅ</div>
              <p class="upload-text">Arraste imagens aqui ou clique para selecionar</p>
              <p class="upload-hint">Suporta: JPG, PNG, GIF (M√°x: 5MB)</p>
              <input 
                #fileInput
                type="file" 
                accept="image/*"
                multiple
                (change)="onFileSelected($event)"
                style="display: none;"
              />
            </div>

            <!-- Preview das Imagens -->
            @if (imagePreviews().length > 0) {
              <div class="image-previews">
                @for (preview of imagePreviews(); track $index) {
                  <div class="image-preview-item">
                    <img [src]="preview.url" [alt]="'Preview ' + $index">
                    <button 
                      type="button" 
                      class="btn-remove-image"
                      (click)="removeImage($index)"
                      title="Remover imagem"
                    >
                      ‚úï
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeModal()">
            Cancelar
          </button>
          <button type="submit" class="btn-save" [disabled]="isSaving()">
            {{ isSaving() ? 'Salvando...' : 'Salvar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
@if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="closeDeleteConfirm()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirmar Exclus√£o</h2>
        <button class="btn-close" (click)="closeDeleteConfirm()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o produto:</p>
        <strong>{{ productToDelete()?.name }}</strong>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeDeleteConfirm()">
          Cancelar
        </button>
        <button class="btn-delete-confirm" (click)="deleteProduct()" [disabled]="isSaving()">
          {{ isSaving() ? 'Excluindo...' : 'Excluir' }}
        </button>
      </div>
    </div>
  </div>
}
